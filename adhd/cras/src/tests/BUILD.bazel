# Copyright 2022 The ChromiumOS Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load("//:utils.bzl", "require_config")

cc_library(
    name = "test_support",
    defines = [
        "CRAS_UT_TMPDIR=\\\"/tmp\\\"",
        "CRAS_SOCKET_FILE_DIR=\\\"/run/cras\\\"",
        "CRAS_CONFIG_FILE_DIR=\\\"/etc\\\"",
    ],
    linkopts = [
        "-Wl,--gc-sections",
        "-lm",
    ],
    deps = [
        "//:build_config",
        "//cras/include",
        "//third_party/strlcpy",
        "//third_party/superfasthash",
        "//third_party/utlist",
    ],
)

cc_test(
    name = "a2dp_info_unittest",
    srcs = [
        ":a2dp_info_unittest.cc",
        ":sbc_codec_stub.cc",
        ":sbc_codec_stub.h",
        "//cras/src/server:cras_a2dp_info.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//third_party/bluez:a2dp_codecs",
        "//third_party/bluez:rtp",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "a2dp_iodev_unittest",
    srcs = [
        ":a2dp_iodev_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//third_party/bluez:a2dp_codecs",
        "//third_party/bluez:rtp",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "a2dp_manager_unittest",
    srcs = [
        ":a2dp_manager_unittest.cc",
        ":test_util.h",
        "//cras/src/server:cras_a2dp_manager.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "alert_unittest",
    srcs = [
        ":alert_unittest.cc",
        "//cras/src/server:cras_alert.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "alsa_card_unittest",
    srcs = [
        ":alsa_card_unittest.cc",
        "//cras/src/server:cras_alsa_card.c",
        "//cras/src/server:cras_alsa_io_ops.c",
        "//cras/src/server:cras_alsa_mixer_name.c",
        "//cras/src/server:cras_alsa_ucm_section.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_features_override",
        "//cras/src/server/config:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "alsa_helpers_unittest",
    srcs = [
        ":alsa_helpers_unittest.cc",
        "//cras/src/common:cras_audio_format.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "alsa_io_unittest",
    srcs = [
        ":alsa_io_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_alsa_io_common.c",
        "//cras/src/server:cras_alsa_mixer_name.c",
        "//cras/src/server:cras_alsa_ucm_section.c",
        "//cras/src/server:softvol_curve.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "cras_alsa_io_ops_unittest",
    srcs = [
        ":cras_alsa_io_ops_unittest.cc",
        "//cras/src/server:cras_alsa_io_ops.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "cras_alsa_usb_io_unittest",
    srcs = [
        ":cras_alsa_usb_io_unittest.cc",
        "//cras/src/server:cras_alsa_io_common.c",
        "//cras/src/server:cras_alsa_mixer_name.c",
        "//cras/src/server:cras_alsa_ucm_section.c",
        "//cras/src/server:softvol_curve.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "alsa_jack_unittest",
    srcs = [
        ":alsa_jack_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/common:edid_utils.c",
        "//cras/src/server:cras_alsa_jack.c",
        "//cras/src/server:cras_alsa_mixer_name.c",
        "//cras/src/server:cras_alsa_ucm_section.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "alsa_mixer_unittest",
    srcs = [
        ":alsa_mixer_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_alsa_mixer_name.c",
        "//cras/src/server:cras_alsa_ucm_section.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "alsa_ucm_unittest",
    srcs = [
        ":alsa_ucm_unittest.cc",
        "//cras/src/server:cras_alsa_mixer_name.c",
        "//cras/src/server:cras_alsa_ucm_section.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "array_unittest",
    srcs = [
        ":array_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "audio_area_unittest",
    srcs = [
        ":audio_area_unittest.cc",
        "//cras/src/server:cras_audio_area.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "audio_format_unittest",
    srcs = [
        ":audio_format_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "audio_thread_monitor_unittest",
    srcs = [
        ":audio_thread_monitor_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "audio_thread_unittest",
    srcs = [
        ":audio_thread_unittest.cc",
        ":empty_audio_stub.cc",
        ":metrics_stub.cc",
        ":metrics_stub.h",
        "//cras/src/common:cras_selinux_helper_stub.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:dev_io.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/rust:headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "biquad_unittest",
    srcs = [
        ":biquad_unittest.cc",
        "//cras/src/dsp:biquad.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "bt_device_unittest",
    srcs = [
        ":bt_device_unittest.cc",
        ":metrics_stub.cc",
        "//cras/src/server:cras_bt_device.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "bt_io_unittest",
    srcs = [
        ":bt_io_unittest.cc",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "bt_manager_unittest",
    srcs = [
        ":bt_manager_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_bt_log.c",
        "//cras/src/server:cras_bt_manager.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "bt_policy_unittest",
    srcs = [
        ":bt_policy_unittest.cc",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "buffer_share_unittest",
    srcs = [
        ":buffer_share_unittest.cc",
        "//cras/src/server:buffer_share.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "byte_buffer_unittest",
    srcs = [
        ":byte_buffer_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "capture_rclient_unittest",
    srcs = [
        ":capture_rclient_unittest.cc",
        "//cras/src/server:cras_rstream_config.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "card_config_unittest",
    srcs = [
        ":card_config_unittest.cc",
        "//cras/src/server/config:cras_card_config.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "checksum_unittest",
    srcs = [
        ":checksum_unittest.cc",
        "//cras/src/common:cras_checksum.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "control_rclient_unittest",
    srcs = [
        ":control_rclient_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_rstream_config.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "cras_abi_unittest",
    srcs = [
        ":cras_abi_unittest.cc",
        "//cras/src/common:cras_audio_format.c",
        "//cras/src/common:cras_config.c",
        "//cras/src/common:cras_file_wait.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/common:cras_util.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/libcras:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//speexdsp",
    ],
)

cc_test(
    name = "cras_client_unittest",
    srcs = [
        ":cras_client_unittest.cc",
        "//cras/src/common:cras_config.c",
        "//cras/src/common:cras_file_wait.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/common:cras_util.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/libcras:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
        "@pkg_config//speexdsp",
    ],
)

cc_test(
    name = "cras_rtc_unittest",
    srcs = [
        ":cras_rtc_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_rtc.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "cras_sco_unittest",
    srcs = [
        ":cras_sco_unittest.cc",
        ":metrics_stub.cc",
        ":sbc_codec_stub.cc",
        ":sbc_codec_stub.h",
        ":sr_bt_util_stub.cc",
        ":sr_bt_util_stub.h",
        ":sr_stub.cc",
        ":sr_stub.h",
        "//cras/src/common:cras_string.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/plc:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "cras_sr_bt_util_unittest",
    srcs = [
        ":cras_sr_bt_util_unittest.cc",
        "//cras/src/server:cras_sr_bt_util.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_features_override",
        "//cras/src/server/rust:headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "cras_tm_unittest",
    srcs = [
        ":cras_tm_unittest.cc",
        "//cras/src/server:cras_tm.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dbus_control_unittest",
    srcs = [
        ":dbus_control_unittest.cc",
        ":dbus_test.cc",
        ":dbus_test.h",
        "//cras/src/common:cras_dbus_bindings.h",
        "//cras/src/server:cras_dbus_control.c",
        "//cras/src/server:cras_dbus_util.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dev_io_unittest",
    srcs = [
        ":dev_io_stubs.cc",
        ":dev_io_stubs.h",
        ":dev_io_unittest.cc",
        ":empty_audio_stub.cc",
        ":iodev_stub.cc",
        ":iodev_stub.h",
        ":metrics_stub.cc",
        ":metrics_stub.h",
        ":rstream_stub.cc",
        ":rstream_stub.h",
        "//cras/src/common:cras_audio_format.c",
        "//cras/src/server:dev_io.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_mix",
        "//cras/src/server/config:all_headers",
        "//cras/src/server/rust:headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
        "@pkg_config//speexdsp",
    ],
)

cc_test(
    name = "dev_stream_unittest",
    srcs = [
        ":dev_io_stubs.cc",
        ":dev_io_stubs.h",
        ":dev_stream_unittest.cc",
        ":iodev_stub.h",
        ":rstream_stub.h",
        "//cras/src/common:cras_selinux_helper_stub.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:dev_stream.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "device_blocklist_unittest",
    srcs = [
        ":device_blocklist_unittest.cc",
        "//cras/src/server/config:cras_device_blocklist.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "device_monitor_unittest",
    srcs = [
        ":device_monitor_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dsp_core_unittest",
    srcs = [
        ":dsp_core_unittest.cc",
        "//cras/src/dsp:biquad.c",
        "//cras/src/dsp:crossover.c",
        "//cras/src/dsp:crossover2.c",
        "//cras/src/dsp:drc.c",
        "//cras/src/dsp:drc_kernel.c",
        "//cras/src/dsp:drc_math.c",
        "//cras/src/dsp:dsp_util.c",
        "//cras/src/dsp:eq.c",
        "//cras/src/dsp:eq2.c",
        "//cras/src/dsp:quad_rotation.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dsp_ini_unittest",
    srcs = [
        ":dsp_ini_unittest.cc",
        "//cras/src/common:dumper.c",
        "//cras/src/server:cras_dsp_ini.c",
        "//cras/src/server:cras_expr.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dsp_pipeline_unittest",
    srcs = [
        ":cras_dsp_pipeline_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/common:dumper.c",
        "//cras/src/dsp:dsp_util.c",
        "//cras/src/server:cras_dsp_ini.c",
        "//cras/src/server:cras_dsp_pipeline.c",
        "//cras/src/server:cras_expr.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dsp_unittest",
    srcs = [
        ":dsp_unittest.cc",
        "//cras/src/common:dumper.c",
        "//cras/src/dsp:dsp_util.c",
        "//cras/src/dsp/tests:dsp_test_util.c",
        "//cras/src/server:cras_dsp.c",
        "//cras/src/server:cras_dsp_ini.c",
        "//cras/src/server:cras_dsp_pipeline.c",
        "//cras/src/server:cras_expr.c",
    ],
    tags = [
        "tsan-broken",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/dsp/tests:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "dumper_unittest",
    srcs = [
        ":dumper_unittest.cc",
        "//cras/src/common:dumper.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "edid_utils_unittest",
    srcs = [
        ":edid_utils_unittest.cc",
        "//cras/src/common:edid_utils.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "empty_iodev_unittest",
    srcs = [
        ":empty_iodev_unittest.cc",
        "//cras/src/server:cras_empty_iodev.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "ewma_power_unittest",
    srcs = [
        ":ewma_power_unittest.cc",
        "//cras/src/common:cras_audio_format.c",
        "//cras/src/server:cras_audio_area.c",
        "//cras/src/server:ewma_power.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "expr_unittest",
    srcs = [
        ":expr_unittest.cc",
        "//cras/src/common:dumper.c",
        "//cras/src/server:cras_expr.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "feature_tier_unittest",
    srcs = [
        ":feature_tier_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/rust",
        "//cras/src/server/rust:headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "file_wait_unittest",
    srcs = [
        ":file_wait_unittest.cc",
        "//cras/src/common:cras_file_wait.c",
        "//cras/src/common:cras_util.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "fl_pcm_iodev_unittest",
    srcs = [
        ":fl_pcm_iodev_unittest.cc",
        "//cras/src/common:cras_string.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "float_buffer_unittest",
    srcs = [
        ":float_buffer_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "floop_iodev_unittest",
    srcs = [
        ":floop_iodev_unittest.cc",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "fmt_conv_ops_unittest",
    srcs = [
        ":fmt_conv_ops_unittest.cc",
        "//cras/src/server:cras_fmt_conv_ops.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
        "@pkg_config//speexdsp",
    ],
)

cc_test(
    name = "fmt_conv_unittest",
    srcs = [
        ":fmt_conv_unittest.cc",
        "//cras/src/server:cras_fmt_conv.c",
        "//cras/src/server:cras_fmt_conv_ops.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
        "@pkg_config//speexdsp",
    ],
)

cc_test(
    name = "hfp_ag_profile_unittest",
    srcs = [
        ":hfp_ag_profile_unittest.cc",
        ":metrics_stub.cc",
        "//cras/src/server:cras_hfp_ag_profile.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_features_override",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "hfp_alsa_iodev_unittest",
    srcs = [
        ":hfp_alsa_iodev_unittest.cc",
        ":sr_bt_util_stub.cc",
        ":sr_bt_util_stub.h",
        ":sr_stub.cc",
        ":sr_stub.h",
        "//cras/src/server:cras_hfp_alsa_iodev.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "hfp_iodev_unittest",
    srcs = [
        ":hfp_iodev_unittest.cc",
        ":sr_bt_util_stub.cc",
        ":sr_bt_util_stub.h",
        "//cras/src/server:cras_hfp_iodev.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "hfp_manager_unittest",
    srcs = [
        ":hfp_manager_unittest.cc",
        ":metrics_stub.cc",
        "//cras/src/server:cras_hfp_manager.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_features_override",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "hfp_slc_unittest",
    srcs = [
        ":hfp_slc_unittest.cc",
        ":metrics_stub.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_hfp_slc.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "input_data_unittest",
    srcs = [
        ":input_data_unittest.cc",
        "//cras/src/server:input_data.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "iodev_list_unittest",
    srcs = [
        ":iodev_list_unittest.cc",
        ":test_util.h",
        "//cras/src/server:cras_speak_on_mute_detector_stub.c",
    ],
    deps = [
        ":scoped_features_override",
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "iodev_unittest",
    srcs = [
        ":iodev_unittest.cc",
        "//cras/src/common:cras_selinux_helper_stub.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_iodev.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/rust:headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "linear_resampler_unittest",
    srcs = [
        ":linear_resampler_unittest.cc",
        "//cras/src/server:cras_audio_area.c",
        "//cras/src/server:linear_resampler.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "loopback_iodev_unittest",
    srcs = [
        ":loopback_iodev_unittest.cc",
        "//cras/src/common:cras_selinux_helper_stub.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_loopback_iodev.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "messages_unittest",
    srcs = [
        ":messages_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "mix_unittest",
    srcs = [
        ":mix_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_mix",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "observer_unittest",
    srcs = [
        ":observer_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
    ],
)

cc_test(
    name = "playback_rclient_unittest",
    srcs = [
        ":playback_rclient_unittest.cc",
        "//cras/src/server:cras_rstream_config.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "polled_interval_checker_unittest",
    srcs = [
        ":polled_interval_checker_unittest.cc",
        "//cras/src/server:polled_interval_checker.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "ramp_unittest",
    srcs = [
        ":ramp_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "rate_estimator_unittest",
    srcs = [
        ":rate_estimator_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/rust",
        "//cras/src/server/rust:headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "rstream_unittest",
    srcs = [
        ":metrics_stub.cc",
        ":metrics_stub.h",
        ":rstream_unittest.cc",
        "//cras/src/common:cras_selinux_helper_stub.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_rstream.c",
        "//cras/src/server:cras_rstream_config.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "sample_buffer_unittest",
    srcs = [
        ":sample_buffer_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "server_metrics_unittest",
    srcs = [
        ":server_metrics_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "shm_unittest",
    srcs = [
        ":shm_unittest.cc",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "softvol_curve_unittest",
    srcs = [
        ":softvol_curve_unittest.cc",
        "//cras/src/server:cras_volume_curve.c",
        "//cras/src/server:softvol_curve.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "speak_on_mute_detector_unittest",
    srcs = [
        ":speak_on_mute_detector_unittest.cc",
        "//cras/src/server:speak_on_mute_detector.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "sr_bt_adapters_unittest",
    srcs = [
        ":sr_bt_adapters_unittest.cc",
        ":sr_bt_util_stub.cc",
        ":sr_bt_util_stub.h",
        ":sr_stub.cc",
        ":sr_stub.h",
        "//cras/src/server:cras_audio_area.c",
        "//cras/src/server:cras_sr_bt_adapters.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "stream_list_unittest",
    srcs = [
        ":stream_list_unittest.cc",
        "//cras/src/server:stream_list.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "string_unittest",
    srcs = [
        ":string_unittest.cc",
        "//cras/src/common:cras_string.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "system_state_unittest",
    srcs = [
        ":system_state_unittest.cc",
        "//cras/src/common:cras_selinux_helper_stub.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_system_state.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/config:all_headers",
        "//cras/src/server/rust:headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "timing_unittest",
    srcs = [
        ":dev_io_stubs.cc",
        ":dev_io_stubs.h",
        ":empty_audio_stub.cc",
        ":iodev_stub.cc",
        ":iodev_stub.h",
        ":metrics_stub.cc",
        ":metrics_stub.h",
        ":rstream_stub.cc",
        ":rstream_stub.h",
        ":timing_unittest.cc",
        "//cras/src/common:cras_audio_format.c",
        "//cras/src/common:cras_shm.c",
        "//cras/src/server:cras_audio_area.c",
        "//cras/src/server:cras_fmt_conv.c",
        "//cras/src/server:cras_fmt_conv_ops.c",
        "//cras/src/server:dev_io.c",
        "//cras/src/server:dev_stream.c",
        "//cras/src/server:linear_resampler.c",
    ],
    copts = [
        "-fdata-sections",
        "-ffunction-sections",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server:cras_mix",
        "//cras/src/server/config:all_headers",
        "//cras/src/server/rust:headers",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//speexdsp",
    ],
)

cc_test(
    name = "utf8_unittest",
    srcs = [
        ":utf8_unittest.cc",
        "//cras/src/server:cras_utf8.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//dbus-1",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "util_unittest",
    srcs = [
        ":util_unittest.cc",
        "//cras/src/common:cras_config.c",
        "//cras/src/common:cras_util.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "volume_curve_unittest",
    srcs = [
        ":volume_curve_unittest.cc",
        "//cras/src/server:cras_volume_curve.c",
    ],
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "stream_apm_unittest",
    srcs = [
        "stream_apm_unittest.cc",
        "//cras/src/common:cras_string.c",
        "//cras/src/server:cras_speak_on_mute_detector_stub.c",
        "//cras/src/server:cras_stream_apm.c",
    ],
    target_compatible_with = require_config("//:apm_build"),
    deps = [
        ":test_support",
        "//cras/src/audio_processor/c:plugin_processor",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "//cras/src/server/rust",
        "@iniparser",
        "@pkg_config//alsa",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
        "@pkg_config//libwebrtc_apm",
    ],
)

cc_test(
    name = "apm_reverse_unittest",
    srcs = [
        "apm_reverse_unittest.cc",
        "//cras/src/server:cras_apm_reverse.c",
    ],
    target_compatible_with = require_config("//:apm_build"),
    deps = [
        ":test_support",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)

cc_test(
    name = "cras_sr_unittest",
    srcs = [
        "am_mock.c",
        "cras_sr_unittest.cc",
        "//cras/src/server:cras_fmt_conv_ops.c",
        "//cras/src/server:cras_sr.c",
    ],
    target_compatible_with = require_config("//:ml_build"),
    deps = [
        ":test_support",
        "//cras/src:include_here_hack",
        "//cras/src/common:all_headers",
        "//cras/src/dsp:all_headers",
        "//cras/src/server:all_headers",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
        "@pkg_config//speexdsp",
    ],
)

cc_library(
    name = "scoped_features_override",
    testonly = True,
    srcs = ["scoped_features_override.cc"],
    hdrs = ["scoped_features_override.h"],
    deps = [
        "//cras/src/server:cras_features",
        "//cras/src/server:cras_features_override",
    ],
)

cc_test(
    name = "scoped_features_override_unittest",
    srcs = ["scoped_features_override_unittest.cc"],
    deps = [
        "scoped_features_override",
        "@pkg_config//gtest",
        "@pkg_config//gtest_main",
    ],
)
